{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "kube-aws Kubernetes cluster development",
  "Parameters": {},
  "Resources": {
    "Controllers": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "HealthCheckGracePeriod": 600,
        "HealthCheckType": "EC2",
        "LaunchConfigurationName": {
          "Ref": "ControllersLC"
        },
        "MaxSize": "4",
        "MetricsCollection": [
          {
            "Granularity": "1Minute"
          }
        ],
        "MinSize": "2",
        "Tags": [
          {
            "Key": "kubernetes.io/cluster/development",
            "PropagateAtLaunch": "true",
            "Value": "true"
          },
          {
            "Key": "Name",
            "PropagateAtLaunch": "true",
            "Value": "development-control-plane-kube-aws-controller"
          },
          {
            "Key": "kubernetes.io/role/master",
            "PropagateAtLaunch": "true",
            "Value": ""
          }
        ],
        "VPCZoneIdentifier": [
          "subnet-93095ccb",
          "subnet-5bdb9271",
          "subnet-af6b53d9",
          "subnet-0117233c"
        ],
        "LoadBalancerNames": [
          {
            "Ref": "APIEndpointDefaultELB"
          }
        ],
        "TargetGroupARNs": []
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Count": "2",
          "Timeout": "PT20M"
        }
      },
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MinInstancesInService": "2",
          "MaxBatchSize": "1",
          "WaitOnResourceSignals": "true",
          "PauseTime": "PT20M"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Init": {
          "configSets": {
            "etcd-client": [
              "etcd-client-env"
            ]
          },
          "etcd-client-env": {
            "files": {
              "/var/run/coreos/etcd-environment": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "ETCD_ENDPOINTS='",
                      "https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd0EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2379",
                      ",",
                      "https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd1EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2379",
                      ",",
                      "https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd2EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2379",
                      "'\n"
                    ]
                  ]
                }
              }
            }
          }
        }
      },
      "DependsOn": [
        "Etcd2"
      ]
    },
    "IAMInstanceProfileController": {
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "IAMRoleController"
          }
        ]
      },
      "Type": "AWS::IAM::InstanceProfile"
    },
    "IAMManagedPolicyController": {
      "Type": "AWS::IAM::ManagedPolicy",
      "Properties": {
        "Description": "Policy for managing kube-aws k8s controllers",
        "Path": "/",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Action": "ec2:*",
              "Effect": "Allow",
              "Resource": "*"
            },
            {
              "Action": "elasticloadbalancing:*",
              "Effect": "Allow",
              "Resource": "*"
            },
            {
              "Effect": "Allow",
              "Action": [
                "s3:GetObject"
              ],
              "Resource": "arn:aws:s3:::us-east-1-checkr-kubernetes-dev/kube-aws/clusters/development/exported/stacks/control-plane/userdata-controller*"
            },
            {
              "Action": "cloudformation:SignalResource",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:cloudformation:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":stack/",
                    {
                      "Ref": "AWS::StackName"
                    },
                    "/*"
                  ]
                ]
              }
            },
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Resource": "*"
            },
            {
              "Action": "kms:Decrypt",
              "Effect": "Allow",
              "Resource": "arn:aws:kms:us-east-1:927411751048:key/a9f9e689-e794-4b46-88a3-7642150a697e"
            },
            {
              "Action": [
                "ecr:GetAuthorizationToken",
                "ecr:BatchCheckLayerAvailability",
                "ecr:GetDownloadUrlForLayer",
                "ecr:GetRepositoryPolicy",
                "ecr:DescribeRepositories",
                "ecr:ListImages",
                "ecr:BatchGetImage"
              ],
              "Resource": "*",
              "Effect": "Allow"
            }
          ]
        }
      }
    },
    "IAMRoleController": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "Path": "/",
        "RoleName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::Region"
              },
              "-",
              "controllerMR"
            ]
          ]
        },
        "ManagedPolicyArns": [
          {
            "Ref": "IAMManagedPolicyController"
          }
        ]
      },
      "Type": "AWS::IAM::Role"
    },
    "IAMInstanceProfileEtcd": {
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "IAMRoleEtcd"
          }
        ]
      },
      "Type": "AWS::IAM::InstanceProfile"
    },
    "IAMManagedPolicyEtcd": {
      "Type": "AWS::IAM::ManagedPolicy",
      "Properties": {
        "Description": "Policy for managing kube-aws k8s etcd nodes",
        "Path": "/",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Action": "kms:Decrypt",
              "Effect": "Allow",
              "Resource": "arn:aws:kms:us-east-1:927411751048:key/a9f9e689-e794-4b46-88a3-7642150a697e"
            },
            {
              "Action": "ec2:DescribeTags",
              "Effect": "Allow",
              "Resource": "*"
            },
            {
              "Action": "ec2:DescribeVolumes",
              "Effect": "Allow",
              "Resource": "*"
            },
            {
              "Action": "ec2:AttachVolume",
              "Effect": "Allow",
              "Resource": "*"
            },
            {
              "Action": "ec2:DescribeVolumeStatus",
              "Effect": "Allow",
              "Resource": "*"
            },
            {
              "Action": "ec2:AssociateAddress",
              "Effect": "Allow",
              "Resource": "*"
            },
            {
              "Effect": "Allow",
              "Action": [
                "s3:GetObject"
              ],
              "Resource": "arn:aws:s3:::us-east-1-checkr-kubernetes-dev/kube-aws/clusters/development/exported/stacks/control-plane/userdata-etcd*"
            },
            {
              "Effect": "Allow",
              "Action": [
                "s3:ListBucket"
              ],
              "Resource": "arn:aws:s3:::us-east-1-checkr-kubernetes-dev"
            },
            {
              "Effect": "Allow",
              "Action": [
                "s3:List*",
                "s3:GetObject*"
              ],
              "Resource": "arn:aws:s3:::us-east-1-checkr-kubernetes-dev",
              "Condition": {
                "StringLike": {
                  "s3:prefix": {
                    "Fn::Join": [
                      "",
                      [
                        {
                          "Fn::Join": [
                            "",
                            [
                              "kube-aws/clusters/development/instances/",
                              {
                                "Fn::Select": [
                                  "2",
                                  {
                                    "Fn::Split": [
                                      "/",
                                      {
                                        "Ref": "AWS::StackId"
                                      }
                                    ]
                                  }
                                ]
                              },
                              "/etcd-snapshots"
                            ]
                          ]
                        },
                        "/*"
                      ]
                    ]
                  }
                }
              }
            },
            {
              "Effect": "Allow",
              "Action": [
                "s3:*"
              ],
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:s3:::",
                    {
                      "Fn::Join": [
                        "",
                        [
                          "us-east-1-checkr-kubernetes-dev/kube-aws/clusters/development/instances/",
                          {
                            "Fn::Select": [
                              "2",
                              {
                                "Fn::Split": [
                                  "/",
                                  {
                                    "Ref": "AWS::StackId"
                                  }
                                ]
                              }
                            ]
                          },
                          "/etcd-snapshots"
                        ]
                      ]
                    },
                    "/*"
                  ]
                ]
              }
            },
            {
              "Action": "ec2:DescribeInstances",
              "Resource": "*",
              "Effect": "Allow"
            }
          ]
        }
      }
    },
    "IAMRoleEtcd": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "Path": "/",
        "ManagedPolicyArns": [
          {
            "Ref": "IAMManagedPolicyEtcd"
          }
        ]
      },
      "Type": "AWS::IAM::Role"
    },
    "Etcd0EIP": {
      "Properties": {
        "Domain": "vpc"
      },
      "Type": "AWS::EC2::EIP"
    },
    "Etcd0EBS": {
      "Properties": {
        "AvailabilityZone": "us-east-1a",
        "Size": "100",
        "Encrypted": true,
        "VolumeType": "gp2",
        "Tags": [
          {
            "Key": "kube-aws:etcd:index",
            "Value": "0"
          },
          {
            "Key": "kube-aws:etcd:eip-allocation-id",
            "Value": {
              "Fn::GetAtt": [
                "Etcd0EIP",
                "AllocationId"
              ]
            }
          },
          {
            "Key": "kube-aws:etcd:advertised-hostname",
            "Value": {
              "Fn::Join": [
                ".",
                [
                  {
                    "Fn::Join": [
                      "-",
                      [
                        "ec2",
                        {
                          "Fn::Join": [
                            "-",
                            {
                              "Fn::Split": [
                                ".",
                                {
                                  "Ref": "Etcd0EIP"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    ]
                  },
                  "compute-1.amazonaws.com"
                ]
              ]
            }
          },
          {
            "Key": "kube-aws:etcd:name",
            "Value": "etcd0"
          }
        ]
      },
      "Type": "AWS::EC2::Volume"
    },
    "Etcd0": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "HealthCheckGracePeriod": 600,
        "HealthCheckType": "EC2",
        "LaunchConfigurationName": {
          "Ref": "Etcd0LC"
        },
        "MaxSize": "1",
        "MetricsCollection": [
          {
            "Granularity": "1Minute"
          }
        ],
        "MinSize": "1",
        "Tags": [
          {
            "Key": "kubernetes.io/cluster/development",
            "PropagateAtLaunch": "true",
            "Value": "true"
          },
          {
            "Key": "Name",
            "PropagateAtLaunch": "true",
            "Value": "development-control-plane-kube-aws-etcd-0"
          },
          {
            "Key": "kube-aws:role",
            "PropagateAtLaunch": "true",
            "Value": "etcd"
          }
        ],
        "VPCZoneIdentifier": [
          "subnet-93095ccb"
        ]
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Count": "1",
          "Timeout": "PT20M"
        }
      },
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MinInstancesInService": "0",
          "MaxBatchSize": "1",
          "WaitOnResourceSignals": "true",
          "PauseTime": "PT20M"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Init": {
          "configSets": {
            "etcd-server": [
              "etcd-server-env"
            ]
          },
          "etcd-server-env": {
            "files": {
              "/var/run/coreos/etcd-environment": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "ETCD_INITIAL_CLUSTER='",
                      "etcd0",
                      "=https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd0EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2380",
                      ",",
                      "etcd1",
                      "=https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd1EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2380",
                      ",",
                      "etcd2",
                      "=https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd2EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2380",
                      "'\n"
                    ]
                  ]
                }
              },
              "/var/run/coreos/etcdadm-environment": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "ETCD_ENDPOINTS='",
                      "https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd0EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2379",
                      ",",
                      "https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd1EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2379",
                      ",",
                      "https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd2EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2379",
                      "'\n",
                      "AWS_DEFAULT_REGION='",
                      "us-east-1",
                      "'\n",
                      "KUBERNETES_CLUSTER='",
                      "development",
                      "'\n",
                      "ETCDCTL_CACERT='",
                      "/etc/ssl/certs/etcd-trusted-ca.pem",
                      "'\n",
                      "ETCDCTL_CERT='",
                      "/etc/ssl/certs/etcd-client.pem",
                      "'\n",
                      "ETCDCTL_KEY='",
                      "/etc/ssl/certs/etcd-client-key.pem",
                      "'\n",
                      "ETCDCTL_CA_FILE='",
                      "/etc/ssl/certs/etcd-trusted-ca.pem",
                      "'\n",
                      "ETCDCTL_CERT_FILE='",
                      "/etc/ssl/certs/etcd-client.pem",
                      "'\n",
                      "ETCDCTL_KEY_FILE='",
                      "/etc/ssl/certs/etcd-client-key.pem",
                      "'\n",
                      "ETCDADM_MEMBER_SYSTEMD_SERVICE_NAME='",
                      "etcd-member",
                      "'\n",
                      "ETCDADM_CLUSTER_SNAPSHOTS_S3_URI='",
                      {
                        "Fn::Join": [
                          "",
                          [
                            "s3://",
                            {
                              "Fn::Join": [
                                "",
                                [
                                  "us-east-1-checkr-kubernetes-dev/kube-aws/clusters/development/instances/",
                                  {
                                    "Fn::Select": [
                                      "2",
                                      {
                                        "Fn::Split": [
                                          "/",
                                          {
                                            "Ref": "AWS::StackId"
                                          }
                                        ]
                                      }
                                    ]
                                  },
                                  "/etcd-snapshots"
                                ]
                              ]
                            }
                          ]
                        ]
                      },
                      "'\n",
                      "ETCDADM_STATE_FILES_DIR='",
                      "/var/run/coreos/etcdadm",
                      "'\n",
                      "ETCDADM_MEMBER_COUNT='",
                      "3",
                      "'\n",
                      "ETCDADM_MEMBER_INDEX='",
                      "0",
                      "'\n",
                      "ETCD_VERSION='",
                      "3.2.9",
                      "'\n"
                    ]
                  ]
                }
              }
            }
          }
        }
      },
      "DependsOn": [
        "Etcd0EIP",
        "Etcd0EBS"
      ]
    },
    "Etcd0LC": {
      "Properties": {
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvda",
            "Ebs": {
              "VolumeSize": "30",
              "VolumeType": "gp2"
            }
          }
        ],
        "IamInstanceProfile": {
          "Ref": "IAMInstanceProfileEtcd"
        },
        "ImageId": "ami-e2d33d98",
        "InstanceType": "r4.large",
        "KeyName": "checkr-devops",
        "SecurityGroups": [
          {
            "Ref": "SecurityGroupEtcd"
          }
        ],
        "PlacementTenancy": "default",
        "UserData": "H4sIAAAAAAAA/4xUa28aRxT9vr/iZou0tuRhvOYR7GijErytUFIcGexWais0zNw1E3ZnyDzAqO1/r2YxNghLDl8Ql/uac885P72jM6nojNk5kEeMkM81JJ/vPuXT/u/jaT4ZXE+Ho+v8j+w8gY8fga6YocYryrVBbSk6LojSApuoVhE0IUQoqpU0WlWoXISPS20cDG5u85vx9Ovt8L4/yafDr/ftV2Ld59jdpy/DwWHac6gb3ea/Dm9GWeOEe1MCsTB3bnlFadq9bF502s2nb1oyh9ZRsVGskpxKZR1THIkUqJx0Gyo092FN+Be+fQdiIGkafJBaJafR3Ti/ve5P+tNfhl/yzFs0gjlGwpOjyHh1cgr/RAAzqbK4kcYfwM5l4SKA9VyWCO+AemtqeM3CgfEK/oogfAhR6LK5tu4lstKlrzATyp4tpBL1v2dWe8MxqzE1aHW5anKtijODTNyocpM54xEIqbRXDvZaOGYe0B0VwtE8traoVq+MPLzzy8SClfZo5FOX3dTD2qOZAcAfGXpIrjdW2DV9fYfDVnswOOOtIwvcWFIYXZHAo+eNv3u2aUq968HWlpfyqmLWoQFC8BF51phJBYRA3Pg5/gBC15W2RFxCGgEIrTD6L7AF2NqCbQEhW4JBY0tiAL4E27qi1FuCzDqSEj5HvjBk4WdoFDq0ROCKhp+ErS3lpQ8rWCpwhaVeBgLTrc5QUOsYX1jKtXJGl2RZMoX0gL3k/P2F6HUvzi9Eb9YtCiZ6HXbZ42naZu20l5732qkoOu3L83aL99rYYr1O6/Ky0+u02l0U71M48oHGgViiaDgaT/qjQT4dXv+wSit0jIQl93V6WksNahkFj+KQ1B71bFHjSX/weTrq/5ZnjZOAMfILEGi5kTMkjj3YF8jj5An0JAZCClkGFOtrxyNWYRakEphIpDi7Z6VHmyWNvack8V7yAje7JLa2V7zUXhTaVMxJra7qKxDFKtzWEKK9W3oH36wORrDzm7g5YQ/2z7+bdav49E2TTaIoCsx7cZdtFqkXkEq68LTA5SK40BuH+j8AAP//MgrlFgAGAAA="
      },
      "Type": "AWS::AutoScaling::LaunchConfiguration"
    },
    "Etcd1EIP": {
      "Properties": {
        "Domain": "vpc"
      },
      "Type": "AWS::EC2::EIP"
    },
    "Etcd1EBS": {
      "Properties": {
        "AvailabilityZone": "us-east-1c",
        "Size": "100",
        "Encrypted": true,
        "VolumeType": "gp2",
        "Tags": [
          {
            "Key": "kube-aws:etcd:index",
            "Value": "1"
          },
          {
            "Key": "kube-aws:etcd:eip-allocation-id",
            "Value": {
              "Fn::GetAtt": [
                "Etcd1EIP",
                "AllocationId"
              ]
            }
          },
          {
            "Key": "kube-aws:etcd:advertised-hostname",
            "Value": {
              "Fn::Join": [
                ".",
                [
                  {
                    "Fn::Join": [
                      "-",
                      [
                        "ec2",
                        {
                          "Fn::Join": [
                            "-",
                            {
                              "Fn::Split": [
                                ".",
                                {
                                  "Ref": "Etcd1EIP"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    ]
                  },
                  "compute-1.amazonaws.com"
                ]
              ]
            }
          },
          {
            "Key": "kube-aws:etcd:name",
            "Value": "etcd1"
          }
        ]
      },
      "Type": "AWS::EC2::Volume"
    },
    "Etcd1": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "HealthCheckGracePeriod": 600,
        "HealthCheckType": "EC2",
        "LaunchConfigurationName": {
          "Ref": "Etcd1LC"
        },
        "MaxSize": "1",
        "MetricsCollection": [
          {
            "Granularity": "1Minute"
          }
        ],
        "MinSize": "1",
        "Tags": [
          {
            "Key": "kubernetes.io/cluster/development",
            "PropagateAtLaunch": "true",
            "Value": "true"
          },
          {
            "Key": "Name",
            "PropagateAtLaunch": "true",
            "Value": "development-control-plane-kube-aws-etcd-1"
          },
          {
            "Key": "kube-aws:role",
            "PropagateAtLaunch": "true",
            "Value": "etcd"
          }
        ],
        "VPCZoneIdentifier": [
          "subnet-5bdb9271"
        ]
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Count": "1",
          "Timeout": "PT20M"
        }
      },
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MinInstancesInService": "0",
          "MaxBatchSize": "1",
          "WaitOnResourceSignals": "true",
          "PauseTime": "PT20M"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Init": {
          "configSets": {
            "etcd-server": [
              "etcd-server-env"
            ]
          },
          "etcd-server-env": {
            "files": {
              "/var/run/coreos/etcd-environment": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "ETCD_INITIAL_CLUSTER='",
                      "etcd0",
                      "=https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd0EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2380",
                      ",",
                      "etcd1",
                      "=https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd1EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2380",
                      ",",
                      "etcd2",
                      "=https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd2EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2380",
                      "'\n"
                    ]
                  ]
                }
              },
              "/var/run/coreos/etcdadm-environment": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "ETCD_ENDPOINTS='",
                      "https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd0EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2379",
                      ",",
                      "https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd1EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2379",
                      ",",
                      "https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd2EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2379",
                      "'\n",
                      "AWS_DEFAULT_REGION='",
                      "us-east-1",
                      "'\n",
                      "KUBERNETES_CLUSTER='",
                      "development",
                      "'\n",
                      "ETCDCTL_CACERT='",
                      "/etc/ssl/certs/etcd-trusted-ca.pem",
                      "'\n",
                      "ETCDCTL_CERT='",
                      "/etc/ssl/certs/etcd-client.pem",
                      "'\n",
                      "ETCDCTL_KEY='",
                      "/etc/ssl/certs/etcd-client-key.pem",
                      "'\n",
                      "ETCDCTL_CA_FILE='",
                      "/etc/ssl/certs/etcd-trusted-ca.pem",
                      "'\n",
                      "ETCDCTL_CERT_FILE='",
                      "/etc/ssl/certs/etcd-client.pem",
                      "'\n",
                      "ETCDCTL_KEY_FILE='",
                      "/etc/ssl/certs/etcd-client-key.pem",
                      "'\n",
                      "ETCDADM_MEMBER_SYSTEMD_SERVICE_NAME='",
                      "etcd-member",
                      "'\n",
                      "ETCDADM_CLUSTER_SNAPSHOTS_S3_URI='",
                      {
                        "Fn::Join": [
                          "",
                          [
                            "s3://",
                            {
                              "Fn::Join": [
                                "",
                                [
                                  "us-east-1-checkr-kubernetes-dev/kube-aws/clusters/development/instances/",
                                  {
                                    "Fn::Select": [
                                      "2",
                                      {
                                        "Fn::Split": [
                                          "/",
                                          {
                                            "Ref": "AWS::StackId"
                                          }
                                        ]
                                      }
                                    ]
                                  },
                                  "/etcd-snapshots"
                                ]
                              ]
                            }
                          ]
                        ]
                      },
                      "'\n",
                      "ETCDADM_STATE_FILES_DIR='",
                      "/var/run/coreos/etcdadm",
                      "'\n",
                      "ETCDADM_MEMBER_COUNT='",
                      "3",
                      "'\n",
                      "ETCDADM_MEMBER_INDEX='",
                      "1",
                      "'\n",
                      "ETCD_VERSION='",
                      "3.2.9",
                      "'\n"
                    ]
                  ]
                }
              }
            }
          }
        }
      },
      "DependsOn": [
        "Etcd0",
        "Etcd1EIP",
        "Etcd1EBS"
      ]
    },
    "Etcd1LC": {
      "Properties": {
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvda",
            "Ebs": {
              "VolumeSize": "30",
              "VolumeType": "gp2"
            }
          }
        ],
        "IamInstanceProfile": {
          "Ref": "IAMInstanceProfileEtcd"
        },
        "ImageId": "ami-e2d33d98",
        "InstanceType": "r4.large",
        "KeyName": "checkr-devops",
        "SecurityGroups": [
          {
            "Ref": "SecurityGroupEtcd"
          }
        ],
        "PlacementTenancy": "default",
        "UserData": "H4sIAAAAAAAA/4xUa28aRxT9vr/iZou0tuRhvOYR7GijErytUFIcGexWais0zNw1E3ZnyDzAqO1/r2YxNghLDl8Ql/uac885P72jM6nojNk5kEeMkM81JJ/vPuXT/u/jaT4ZXE+Ho+v8jyxN4ONHoCtmqPGKcm1QW4qOC6K0wCaqVQRNCBGKaiWNVhUqF+HjUhsHg5vb/GY8/Xo7vO9P8unw6337lVj3OXb36ctwcJj2HOpGt/mvw5tR1jjh3pRALMydW15RmnYvmxeddvPpm5bMoXVUbBSrJKdSWccURyIFKifdhgrNfVgT/oVv34EYSJoGH6RWyWl0N85vr/uT/vSX4Zc88xaNYI6R8OQoMl6dnMI/EcBMqixupPEHsHNZuAhgPZclwjug3poaXrNwYLyCvyIIH0IUumyurXuJrHTpK8yEsmcLqUT975nV3nDMakwNWl2umlyr4swgEzeq3GTOeARCKu2Vg70WjpkHdEeFcDSPrS2q1SsjD+/8MrFgpT0a+dRlN/Ww9mhmAPBHhh6S640Vdk1f3+Gw1R4MznjryAI3lhRGVyTw6Hnj755tmlLverC15aW8qph1aIAQfESeNWZSASEQN36OP4DQdaUtEZeQRgBCK4z+C2wBtrZgW0DIlmDQ2JIYgC/Btq4o9ZYgs46khM+RLwxZ+BkahQ4tEbii4Sdha0t56cMKlgpcYamXgcB0qzMU1DrGF5ZyrZzRJVmWTCE9YC85f38het2L8wvRm3WLgoleh132eJq2WTvtpee9diqKTvvyvN3ivTa2WK/Turzs9DqtdhfF+xSOfKBxIJYoGo7Gk/5okE+H1z+s0godI2HJfZ2e1lKDWkbBozgktUc9W9R40h98no76v+VZ4yRgjPwCBFpu5AyJYw/2BfI4eQI9iYGQQpYBxfra8YhVmAWpBCYSKc7uWenRZklj7ylJvJe8wM0uia3tFS+1F4U2FXNSq6v6CkSxCrc1hGjvlt7BN6uDEez8Jm5O2IP98+9m3So+fdNkkyiKAvNe3GWbReoFpJIuPC1wuQgu9Mah/g8AAP//Xg/JxAAGAAA="
      },
      "Type": "AWS::AutoScaling::LaunchConfiguration"
    },
    "Etcd2EIP": {
      "Properties": {
        "Domain": "vpc"
      },
      "Type": "AWS::EC2::EIP"
    },
    "Etcd2EBS": {
      "Properties": {
        "AvailabilityZone": "us-east-1d",
        "Size": "100",
        "Encrypted": true,
        "VolumeType": "gp2",
        "Tags": [
          {
            "Key": "kube-aws:etcd:index",
            "Value": "2"
          },
          {
            "Key": "kube-aws:etcd:eip-allocation-id",
            "Value": {
              "Fn::GetAtt": [
                "Etcd2EIP",
                "AllocationId"
              ]
            }
          },
          {
            "Key": "kube-aws:etcd:advertised-hostname",
            "Value": {
              "Fn::Join": [
                ".",
                [
                  {
                    "Fn::Join": [
                      "-",
                      [
                        "ec2",
                        {
                          "Fn::Join": [
                            "-",
                            {
                              "Fn::Split": [
                                ".",
                                {
                                  "Ref": "Etcd2EIP"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    ]
                  },
                  "compute-1.amazonaws.com"
                ]
              ]
            }
          },
          {
            "Key": "kube-aws:etcd:name",
            "Value": "etcd2"
          }
        ]
      },
      "Type": "AWS::EC2::Volume"
    },
    "Etcd2": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "HealthCheckGracePeriod": 600,
        "HealthCheckType": "EC2",
        "LaunchConfigurationName": {
          "Ref": "Etcd2LC"
        },
        "MaxSize": "1",
        "MetricsCollection": [
          {
            "Granularity": "1Minute"
          }
        ],
        "MinSize": "1",
        "Tags": [
          {
            "Key": "kubernetes.io/cluster/development",
            "PropagateAtLaunch": "true",
            "Value": "true"
          },
          {
            "Key": "Name",
            "PropagateAtLaunch": "true",
            "Value": "development-control-plane-kube-aws-etcd-2"
          },
          {
            "Key": "kube-aws:role",
            "PropagateAtLaunch": "true",
            "Value": "etcd"
          }
        ],
        "VPCZoneIdentifier": [
          "subnet-af6b53d9"
        ]
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Count": "1",
          "Timeout": "PT20M"
        }
      },
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MinInstancesInService": "0",
          "MaxBatchSize": "1",
          "WaitOnResourceSignals": "true",
          "PauseTime": "PT20M"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Init": {
          "configSets": {
            "etcd-server": [
              "etcd-server-env"
            ]
          },
          "etcd-server-env": {
            "files": {
              "/var/run/coreos/etcd-environment": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "ETCD_INITIAL_CLUSTER='",
                      "etcd0",
                      "=https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd0EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2380",
                      ",",
                      "etcd1",
                      "=https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd1EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2380",
                      ",",
                      "etcd2",
                      "=https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd2EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2380",
                      "'\n"
                    ]
                  ]
                }
              },
              "/var/run/coreos/etcdadm-environment": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "ETCD_ENDPOINTS='",
                      "https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd0EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2379",
                      ",",
                      "https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd1EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2379",
                      ",",
                      "https://",
                      {
                        "Fn::Join": [
                          ".",
                          [
                            {
                              "Fn::Join": [
                                "-",
                                [
                                  "ec2",
                                  {
                                    "Fn::Join": [
                                      "-",
                                      {
                                        "Fn::Split": [
                                          ".",
                                          {
                                            "Ref": "Etcd2EIP"
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              ]
                            },
                            "compute-1.amazonaws.com"
                          ]
                        ]
                      },
                      ":2379",
                      "'\n",
                      "AWS_DEFAULT_REGION='",
                      "us-east-1",
                      "'\n",
                      "KUBERNETES_CLUSTER='",
                      "development",
                      "'\n",
                      "ETCDCTL_CACERT='",
                      "/etc/ssl/certs/etcd-trusted-ca.pem",
                      "'\n",
                      "ETCDCTL_CERT='",
                      "/etc/ssl/certs/etcd-client.pem",
                      "'\n",
                      "ETCDCTL_KEY='",
                      "/etc/ssl/certs/etcd-client-key.pem",
                      "'\n",
                      "ETCDCTL_CA_FILE='",
                      "/etc/ssl/certs/etcd-trusted-ca.pem",
                      "'\n",
                      "ETCDCTL_CERT_FILE='",
                      "/etc/ssl/certs/etcd-client.pem",
                      "'\n",
                      "ETCDCTL_KEY_FILE='",
                      "/etc/ssl/certs/etcd-client-key.pem",
                      "'\n",
                      "ETCDADM_MEMBER_SYSTEMD_SERVICE_NAME='",
                      "etcd-member",
                      "'\n",
                      "ETCDADM_CLUSTER_SNAPSHOTS_S3_URI='",
                      {
                        "Fn::Join": [
                          "",
                          [
                            "s3://",
                            {
                              "Fn::Join": [
                                "",
                                [
                                  "us-east-1-checkr-kubernetes-dev/kube-aws/clusters/development/instances/",
                                  {
                                    "Fn::Select": [
                                      "2",
                                      {
                                        "Fn::Split": [
                                          "/",
                                          {
                                            "Ref": "AWS::StackId"
                                          }
                                        ]
                                      }
                                    ]
                                  },
                                  "/etcd-snapshots"
                                ]
                              ]
                            }
                          ]
                        ]
                      },
                      "'\n",
                      "ETCDADM_STATE_FILES_DIR='",
                      "/var/run/coreos/etcdadm",
                      "'\n",
                      "ETCDADM_MEMBER_COUNT='",
                      "3",
                      "'\n",
                      "ETCDADM_MEMBER_INDEX='",
                      "2",
                      "'\n",
                      "ETCD_VERSION='",
                      "3.2.9",
                      "'\n"
                    ]
                  ]
                }
              }
            }
          }
        }
      },
      "DependsOn": [
        "Etcd1",
        "Etcd2EIP",
        "Etcd2EBS"
      ]
    },
    "Etcd2LC": {
      "Properties": {
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvda",
            "Ebs": {
              "VolumeSize": "30",
              "VolumeType": "gp2"
            }
          }
        ],
        "IamInstanceProfile": {
          "Ref": "IAMInstanceProfileEtcd"
        },
        "ImageId": "ami-e2d33d98",
        "InstanceType": "r4.large",
        "KeyName": "checkr-devops",
        "SecurityGroups": [
          {
            "Ref": "SecurityGroupEtcd"
          }
        ],
        "PlacementTenancy": "default",
        "UserData": "H4sIAAAAAAAA/4xUa28aRxT9vr/iZou0tuRhvLyCHW1UYm8rlBRHBruV2goNM3fNhN0ZMg8wavvfq1mMDcKSwxfE5b7m3HPOT+/oTCo6Y3YO5BEj5HMNyee7T/l08Pt4mk+urqfD0XX+R9ZK4ONHoCtmqPGKcm1QW4qOC6K0wCaqVQRNCBGKaiWNVhUqF+HjUhsHVze3+c14+vV2eD+Y5NPh1/vOK7Hec+zu05fh1WHac6gX3ea/Dm9GWeOEe1MCsTB3bnlJadq7aLa6nebTNy2ZQ+uo2ChWSU6lso4pjkQKVE66DRWa+7Am/AvfvgMxkDQNPkitktPobpzfXg8mg+kvwy955i0awRwj4clRZLw6OYV/IoCZVFncSOMPYOeycBHAei5LhHdAvTU1vGbhwHgFf0UQPoQodNlcW/cSWenSV5gJZc8WUon63zOrveGY1ZgatLpcNblWxZlBJm5Uucmc8QiEVNorB3stHDMP6I4K4WgeW1tUq1dGHt75ZWLBSns08qnLbuph7dHMAOCPDD0k1xsr7Jq+vsNhqz0YnPHWkQVuLCmMrkjg0fPG3z3bNKXe9WBry0t5WTHr0AAh+Ig8a8ykAkIgbvwcfwCh60pbIi4hjQCEVhj9F9gCbG3BtoGQLcGgsSUxAF+CbV9S6i1BZh1JCZ8jXxiy8DM0Ch1aInBFw0/C1pby0ocVLBW4wlIvA4HpVmcoqHWMLyzlWjmjS7IsmUJ6wF5y/r4l+r3WeUv0Z72iYKLfZRd9nqYd1kn76Xm/k4qi27k477R5v4Nt1u+2Ly66/W6700PxPoUjH2gciCWKhqPxZDC6yqfD6x9WaYWOkbDkvk5Pa6lBLaPgURyS2qOeLWo8GVx9no4Gv+VZ4yRgjLwFAi03cobEsQf7AnmcPIGexEBIIcuAYn3teMQqzIJUAhOJFGf3rPRos6Sx95Qk3kte4GaXxNb2kpfai0Kbijmp1WV9BaJYhdsaQrR3S+/gm9XBCHZ+Ezcn7MH++XezbhWfvmmySRRFgXkv7rLNIvUCUkkXnha4XAQXeuNQ/wcAAP//qwbMaQAGAAA="
      },
      "Type": "AWS::AutoScaling::LaunchConfiguration"
    },
    "ControllersLC": {
      "Properties": {
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvda",
            "Ebs": {
              "VolumeSize": "100",
              "VolumeType": "gp2"
            }
          }
        ],
        "IamInstanceProfile": {
          "Ref": "IAMInstanceProfileController"
        },
        "ImageId": "ami-e2d33d98",
        "InstanceType": "r4.large",
        "KeyName": "checkr-devops",
        "SecurityGroups": [
          {
            "Ref": "SecurityGroupController"
          }
        ],
        "PlacementTenancy": "default",
        "UserData": "H4sIAAAAAAAA/3xSW08bPRB9318x6EPiq8TEubEJVHmgNK0ioQaFy1Ml5LVnyTaOHTzjDZH646slAcpFfVrNzJ5zrHPOf3uqqLwqNM8BHyiDFigSo8jXVQx+SV4yeliFKHA2nY2nl7cXs8nN6dX4dnJx0/9glz/vrr+cT85e//a8yrPZ+Ptk+mO0/79J0QEyzEVWJ0p18uNW96jf2n2V00Isym68XlZGVZ5Fe0NYWfJSyUbZYFLzTPgNv+4BIxy0It1VwR98yq4vx7Ovp1ent98m5+NRYopWi0YTvMTgHMVsPa8cwR6oxPHRibgQiMnDzwwAED3JaB5YnuY6uLSkkfV8uKi8fbwdckjR0OjRuEgcXN0ywZeHkbSdercZSUwEiMuQvMBfFKLjHck7ILxR02smX38gWOuoYvLKhEiBX/RK7fid4I7lSfM19klRYmLBBW0YyxiW2KSyO94nvWlVYQdQes3GVSdLzUIREOmBTKMBiMA9QNymAPvbpAHMCrh3olRiJM2CHTRzMouIi1RQ9CTEaKlWzYh6zcq41HCzslSTC6smZbUtI1nFos2C1S5LXDntSX0QMRZ9KnU+tJ0yN21DnUFZlGZIedsOj21xpI8Hg7w/7A90r3vUNu2u7XdzrTtlp+wVtmsLeGOV2n9Vq89gQwbAjmgFncwGT1njxUultjA0LiRb+UoAt96WTfX+TZ79CQAA//8gBsNWoAMAAA=="
      },
      "Type": "AWS::AutoScaling::LaunchConfiguration"
    },
    "APIEndpointDefaultELBRecordSet": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneId": "Z29MODHVVGZ870",
        "Name": "kube.checkrhq-dev.net",
        "TTL": 300,
        "ResourceRecords": [
          {
            "Fn::GetAtt": [
              "APIEndpointDefaultELB",
              "DNSName"
            ]
          }
        ],
        "Type": "CNAME"
      }
    },
    "APIEndpointDefaultELB": {
      "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties": {
        "CrossZone": true,
        "HealthCheck": {
          "HealthyThreshold": "3",
          "Interval": "10",
          "Target": "SSL:443",
          "Timeout": "8",
          "UnhealthyThreshold": "3"
        },
        "ConnectionSettings": {
          "IdleTimeout": "3600"
        },
        "Subnets": [
          "subnet-93095ccb",
          "subnet-5bdb9271",
          "subnet-af6b53d9",
          "subnet-0117233c"
        ],
        "Listeners": [
          {
            "InstancePort": "443",
            "InstanceProtocol": "TCP",
            "LoadBalancerPort": "443",
            "Protocol": "TCP"
          }
        ],
        "Scheme": "internal",
        "SecurityGroups": [
          {
            "Ref": "APIEndpointDefaultSG"
          },
          {
            "Ref": "SecurityGroupElbAPIServer"
          }
        ]
      }
    },
    "APIEndpointDefaultSG": {
      "Properties": {
        "GroupDescription": {
          "Ref": "AWS::StackName"
        },
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": 443,
            "IpProtocol": "tcp",
            "ToPort": 443
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "development-sg-api-endpoint-default"
          }
        ],
        "VpcId": "vpc-453b9822"
      },
      "Type": "AWS::EC2::SecurityGroup"
    },
    "SecurityGroupElbAPIServer": {
      "Properties": {
        "GroupDescription": {
          "Ref": "AWS::StackName"
        },
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": -1,
            "IpProtocol": "icmp",
            "ToPort": -1
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "development-sg-elb-api-server"
          }
        ],
        "VpcId": "vpc-453b9822"
      },
      "Type": "AWS::EC2::SecurityGroup"
    },
    "SecurityGroupController": {
      "Properties": {
        "GroupDescription": {
          "Ref": "AWS::StackName"
        },
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": -1,
            "IpProtocol": "icmp",
            "ToPort": -1
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": 0,
            "IpProtocol": "tcp",
            "ToPort": 65535
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": 0,
            "IpProtocol": "udp",
            "ToPort": 65535
          }
        ],
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": -1,
            "IpProtocol": "icmp",
            "ToPort": -1
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": 22,
            "IpProtocol": "tcp",
            "ToPort": 22
          },
          {
            "SourceSecurityGroupId": {
              "Ref": "SecurityGroupElbAPIServer"
            },
            "FromPort": 443,
            "IpProtocol": "tcp",
            "ToPort": 443
          },
          {
            "SourceSecurityGroupId": {
              "Ref": "SecurityGroupWorker"
            },
            "FromPort": 443,
            "IpProtocol": "tcp",
            "ToPort": 443
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "development-sg-controller"
          }
        ],
        "VpcId": "vpc-453b9822"
      },
      "Type": "AWS::EC2::SecurityGroup"
    },
    "SecurityGroupControllerIngressFromControllerToController": {
      "Properties": {
        "FromPort": 443,
        "GroupId": {
          "Ref": "SecurityGroupController"
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": {
          "Ref": "SecurityGroupController"
        },
        "ToPort": 443
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    },
    "SecurityGroupControllerIngressFromControllerToKubelet": {
      "Properties": {
        "FromPort": 10250,
        "GroupId": {
          "Ref": "SecurityGroupController"
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": {
          "Ref": "SecurityGroupController"
        },
        "ToPort": 10250
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    },
    "SecurityGroupControllerIngressFromWorkerToEtcd": {
      "Properties": {
        "FromPort": 2379,
        "GroupId": {
          "Ref": "SecurityGroupController"
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": {
          "Ref": "SecurityGroupWorker"
        },
        "ToPort": 2379
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    },
    "SecurityGroupWorker": {
      "Properties": {
        "GroupDescription": {
          "Ref": "AWS::StackName"
        },
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": -1,
            "IpProtocol": "icmp",
            "ToPort": -1
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": 0,
            "IpProtocol": "tcp",
            "ToPort": 65535
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": 0,
            "IpProtocol": "udp",
            "ToPort": 65535
          }
        ],
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": 22,
            "IpProtocol": "tcp",
            "ToPort": 22
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": -1,
            "IpProtocol": "icmp",
            "ToPort": -1
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "development-sg-worker"
          }
        ],
        "VpcId": "vpc-453b9822"
      },
      "Type": "AWS::EC2::SecurityGroup"
    },
    "SecurityGroupWorkerIngressFromControllerToFlannel": {
      "Properties": {
        "FromPort": 8472,
        "GroupId": {
          "Ref": "SecurityGroupWorker"
        },
        "IpProtocol": "udp",
        "SourceSecurityGroupId": {
          "Ref": "SecurityGroupController"
        },
        "ToPort": 8472
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    },
    "SecurityGroupWorkerIngressFromFlannelToController": {
      "Properties": {
        "FromPort": 8472,
        "GroupId": {
          "Ref": "SecurityGroupController"
        },
        "IpProtocol": "udp",
        "SourceSecurityGroupId": {
          "Ref": "SecurityGroupWorker"
        },
        "ToPort": 8472
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    },
    "SecurityGroupWorkerIngressFromControllerToKubelet": {
      "Properties": {
        "FromPort": 10250,
        "GroupId": {
          "Ref": "SecurityGroupWorker"
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": {
          "Ref": "SecurityGroupController"
        },
        "ToPort": 10250
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    },
    "SecurityGroupWorkerIngressFromControllerTocAdvisor": {
      "Properties": {
        "FromPort": 4194,
        "GroupId": {
          "Ref": "SecurityGroupWorker"
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": {
          "Ref": "SecurityGroupController"
        },
        "ToPort": 4194
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    },
    "SecurityGroupEtcdIngressFromControllerToEtcd": {
      "Properties": {
        "FromPort": 2379,
        "GroupId": {
          "Ref": "SecurityGroupEtcd"
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": {
          "Ref": "SecurityGroupController"
        },
        "ToPort": 2379
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    },
    "SecurityGroupEtcdIngressFromWorkerToEtcd": {
      "Properties": {
        "FromPort": 2379,
        "GroupId": {
          "Ref": "SecurityGroupEtcd"
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": {
          "Ref": "SecurityGroupWorker"
        },
        "ToPort": 2379
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    },
    "SecurityGroupWorkerIngressFromWorkerToFlannel": {
      "Properties": {
        "FromPort": 8472,
        "GroupId": {
          "Ref": "SecurityGroupWorker"
        },
        "IpProtocol": "udp",
        "SourceSecurityGroupId": {
          "Ref": "SecurityGroupWorker"
        },
        "ToPort": 8472
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    },
    "SecurityGroupWorkerIngressFromWorkerToWorkerKubeletReadOnly": {
      "Properties": {
        "FromPort": 10255,
        "GroupId": {
          "Ref": "SecurityGroupWorker"
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": {
          "Ref": "SecurityGroupWorker"
        },
        "ToPort": 10255
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    },
    "SecurityGroupWorkerIngressFromWorkerToControllerKubeletReadOnly": {
      "Properties": {
        "FromPort": 10255,
        "GroupId": {
          "Ref": "SecurityGroupController"
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": {
          "Ref": "SecurityGroupWorker"
        },
        "ToPort": 10255
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    },
    "SecurityGroupEtcd": {
      "Properties": {
        "GroupDescription": {
          "Ref": "AWS::StackName"
        },
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": 0,
            "IpProtocol": "tcp",
            "ToPort": 65535
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": 0,
            "IpProtocol": "udp",
            "ToPort": 65535
          }
        ],
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": 22,
            "IpProtocol": "tcp",
            "ToPort": 22
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": 3,
            "IpProtocol": "icmp",
            "ToPort": -1
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "development-sg-etcd"
          }
        ],
        "VpcId": "vpc-453b9822"
      },
      "Type": "AWS::EC2::SecurityGroup"
    },
    "SecurityGroupEtcdPeerHealthCheckIngress": {
      "Properties": {
        "FromPort": 2379,
        "GroupId": {
          "Ref": "SecurityGroupEtcd"
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": {
          "Ref": "SecurityGroupEtcd"
        },
        "ToPort": 2379
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    },
    "SecurityGroupEtcdPeerIngress": {
      "Properties": {
        "FromPort": 2380,
        "GroupId": {
          "Ref": "SecurityGroupEtcd"
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": {
          "Ref": "SecurityGroupEtcd"
        },
        "ToPort": 2380
      },
      "Type": "AWS::EC2::SecurityGroupIngress"
    }
  },
  "Outputs": {
    "Etcd0EIP": {
      "Description": "The EIP for etcd node 0",
      "Value": {
        "Ref": "Etcd0EIP"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-Etcd0EIP"
        }
      }
    },
    "Etcd1EIP": {
      "Description": "The EIP for etcd node 1",
      "Value": {
        "Ref": "Etcd1EIP"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-Etcd1EIP"
        }
      }
    },
    "Etcd2EIP": {
      "Description": "The EIP for etcd node 2",
      "Value": {
        "Ref": "Etcd2EIP"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-Etcd2EIP"
        }
      }
    },
    "ControllerIAMRoleArn": {
      "Description": "The ARN of the IAM role for Controllers",
      "Value": {
        "Fn::GetAtt": [
          "IAMRoleController",
          "Arn"
        ]
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-ControllerIAMRoleArn"
        }
      }
    },
    "WorkerSecurityGroup": {
      "Description": "The security group assigned to worker nodes",
      "Value": {
        "Ref": "SecurityGroupWorker"
      },
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-WorkerSecurityGroup"
        }
      }
    },
    "StackName": {
      "Description": "The name of this stack which is used by node pool stacks to import outputs from this stack",
      "Value": {
        "Ref": "AWS::StackName"
      }
    }
  }
}
